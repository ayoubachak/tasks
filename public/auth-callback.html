<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authenticating...</title>
</head>
<body>
  <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: system-ui;">
    <div style="text-align: center;">
      <p>Completing authentication...</p>
      <div style="margin-top: 20px; font-size: 14px; color: #666;">You can close this window.</div>
    </div>
  </div>
  <script>
    // Extract OAuth parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');

    // Determine the target origin for postMessage
    // Use the same origin as the current page (which should match the opener)
    const targetOrigin = window.location.origin;
    
    console.log('OAuth callback received:', { code: !!code, state: !!state, error: !!error });
    console.log('Window opener:', window.opener ? 'exists' : 'null');
    console.log('Target origin:', targetOrigin);

    // Send message to parent window (the main app)
    if (window.opener && !window.opener.closed) {
      console.log('Sending message to opener...');
      try {
        if (error) {
          window.opener.postMessage({
            type: 'oauth-error',
            error: error
          }, targetOrigin);
          // Wait a bit before closing to ensure message is received
          setTimeout(() => {
            if (!window.closed) window.close();
          }, 500);
        } else if (code && state) {
          console.log('Posting oauth-callback message...');
          window.opener.postMessage({
            type: 'oauth-callback',
            code: code,
            state: state
          }, targetOrigin);
          console.log('Message sent, closing popup in 300ms...');
          // Wait a moment to ensure message is received, then close
          setTimeout(() => {
            if (!window.closed) {
              console.log('Closing popup window...');
              window.close();
            }
          }, 300);
        } else {
          // No code/state and no error - something went wrong
          window.opener.postMessage({
            type: 'oauth-error',
            error: 'No authorization code received'
          }, targetOrigin);
          setTimeout(() => {
            if (!window.closed) window.close();
          }, 500);
        }
      } catch (e) {
        console.error('Error sending message to opener:', e);
        // If postMessage fails, try to redirect the opener
        try {
          const basePath = window.location.pathname.includes('/tasks/') ? '/tasks' : '';
          if (code && state) {
            window.opener.location.href = `${targetOrigin}${basePath}/?oauth_callback=1&code=${code}&state=${state}`;
          }
        } catch (e2) {
          console.error('Error redirecting opener:', e2);
        }
        setTimeout(() => {
          if (!window.closed) window.close();
        }, 1000);
      }
    } else {
      // If not in popup or opener is closed, redirect to main app (fallback for direct access)
      const basePath = window.location.pathname.includes('/tasks/') ? '/tasks' : '';
      if (code && state) {
        // Store in sessionStorage and redirect
        sessionStorage.setItem('oauth_callback_code', code);
        sessionStorage.setItem('oauth_callback_state', state);
        window.location.href = `${targetOrigin}${basePath}/?oauth_callback=1`;
      } else if (error) {
        sessionStorage.setItem('oauth_callback_error', error);
        window.location.href = `${targetOrigin}${basePath}/?oauth_error=1`;
      } else {
        window.location.href = `${targetOrigin}${basePath}/`;
      }
    }
  </script>
</body>
</html>

